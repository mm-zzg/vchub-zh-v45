# 冗余

WAGO VC Hub支持双机主备，就是两个相同的设备同时运行，一个设备是主节点，另一个是备节点。两个节点的配置需完全相同(需要手动将主节点的数据导入到备份节点)，详见[冗余配置同步](synchronization.md) 。

## 主备节点网络通信

主备节点会通过TCP/IP相互通信， 主节点会监听8099端口(8099为默认端口，该端口可配置)。备份节点会向主节点监听的8099端口建立连接。

![alt text](1.png)

## 状态监控

在冗余的配置界面能够看到实时的冗余状态

![alt text](2.png)

当前节点和冗余节点的状态包含以下几种

| **节点状态** | **描述**|
|:--------------|:-----------------------------------------------------------------------------------------------------|
| Running      | 运行状态，主节点的默认状态。|
| Standby      | 待命状态，备节点的默认状态，当主节点宕机后，备节点会切换成Running状态。                                 |
| Faulted      | 错误状态，当备节点无法与主节点建立冗余连接时，备节点上的冗余节点状态会显示成Faulted。                  |
| Unknown      | 未知状态，未获取到冗余节点状态，比如冗余节点正处于启动状态。                                           |
| Disconnected | 连接断开状态，当主节点启动后没有备节点与主节点建立连接时，主节点上的冗余节点状态会显示成Disconnected。 |

冗余节点授权：

| **节点授权** | **描述**                          |
|:--------------|:-----------------------------------|
| Unknown      | 未获取到冗余节点的授权信息。       |
| Match        | 主备节点的许可证的授权模块一致。   |
| Mismatch     | 主备节点的许可证的授权模块不一致。 |

## 运行时数据同步

主备节点运行时会同步实时数据，实时数据包括变量和报警。主备节点初次建立连接时会先进行一次全量同步，然后持续进行增量同步。

## 主备切换

#### 自动切换

1. 机器A设置为主服务器，机器B设置为备服务器。机器A的冗余配置页面，恢复方式选择自动。
2. 机器A和机器B形成冗余。机器A的节点状态为Running，机器B的节点状态为Standby。
3. 机器A在运行过程中宕机，此时机器B变为Running状态，机器A的状态变为Faulted。
4. 机器A恢复正常，机器A的状态变为Running，机器B处于Standby状态。

#### 手动切换

1. 机器A设置为主服务器，机器B设置为备服务器。机器A的冗余配置页面，恢复方式选择 **手动。**
2. 机器A和机器B形成冗余。机器A的节点状态为Running，机器B的节点状态为Standby。
3. 机器A在运行过程中宕机，此时机器B变为Running状态，机器A的状态变为Faulted。
4. 机器A恢复正常，但此时机器A的状态仍为Standby，机器B处于Running状态。
5. 在机器A的”网络“->”冗余“页面，点击”切换“按钮。

    ![alt text](3.png)

    切换后，机器A重新变为Running状态，机器B变为Standby状态。

6. 如果此时继续点击”切换“按钮，机器A会重新变为Standby状态，机器B变为Running状态。

## 重要提示

由于历史数据是按节点名称存储的，因此在配置两个节点的冗余后，必须将冗余节点的节点名称更改为主节点的节点名称。否则，备用节点将无法查询从主节点传输的历史数据。

如果主节点和备用节点之间已建立网络连接，强烈建议断开这两个节点之间的网络连接，以避免潜在的意外错误。